# Тестовое задание: Модуль «Избранное» для каталога товаров

Разработай модуль для 1С-Битрикс, реализующий функционал «Избранное» (Wishlist) для каталога товаров. При необходиомости смотри в документацию /pages и ядро Битрикса /bitrix 

## Функциональные требования

### 1. Добавление/удаление товаров в избранное
- Пользователь может добавить товар в избранное
- Пользователь может удалить товар из избранного
- Пользователь может получить список избранных товаров

### 2. Хранение данных

| Тип пользователя | Хранилище | Требования |
|------------------|-----------|------------|
| Авторизованный | База данных | Собственная таблица через ORM DataManager |
| Гость | Cookie | Шифрованные cookie (`CryptoCookie`) |

### 3. Миграция данных гостя
При авторизации пользователя его избранное из cookie должно автоматически переноситься в базу данных. Дубликаты не должны создаваться.

### 4. REST API
Модуль должен предоставлять API через `\Bitrix\Main\Engine\Controller`:

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `favorites.add` | Добавить товар в избранное |
| POST | `favorites.remove` | Удалить товар из избранного |
| GET | `favorites.list` | Получить список ID избранных товаров |
| GET | `favorites.getProducts` | Получить список товаров с данными |

### 5. Публичный компонент
Модуль должен включать публичный компонент `vendor:favorites.button` для размещения на странице товара:

**Функционал компонента:**
- Кнопка добавления/удаления товара из избранного
- Визуальное состояние: показывает, в избранном ли товар
- AJAX-взаимодействие без перезагрузки страницы
- Анимация при добавлении/удалении

**Дизайн требования:**
- Современный минималистичный UI
- Плавные CSS-анимации (hover, click, состояние)
- Иконка сердечка (заполненное/пустое)
- Адаптивность под мобильные устройства
- Тёмная и светлая тема (опционально)

**Параметры компонента:**
- `PRODUCT_ID` — ID товара
- `SHOW_COUNTER` — показывать счётчик добавлений (да/нет)
- `BUTTON_SIZE` — размер кнопки (small/medium/large)

### 6. Кэширование
- Список избранного для авторизованного пользователя должен кэшироваться
- При изменении или удалении товара в инфоблоке кэш должен инвалидироваться через теги
- Использовать механизм тегированного кэша D7

### 7. Административный интерфейс
Страница настроек модуля с возможностью:
- Выбрать инфоблок каталога товаров
- Задать время жизни cookie для гостей
- Включить/выключить функционал модуля

## Технические требования

### Производительность
- API-запросы должны выполняться не более 100ms
- Кэширование обязательно для списка товаров

### Безопасность
- Cookie должны быть зашифрованы (`CryptoCookie`)
- Валидация всех входящих параметров (ID товара — положительное целое число)
- Проверка существования товара в инфоблоке перед добавлением
- CSRF-защита для API-методов

### Совместимость
- Bitrix 20.x+ и PHP 8.1+
- Использование исключительно D7 API
- Работа с инфоблоками через `\Bitrix\Iblock\Elements`

### Ограничения
- Запрещено модифицировать ядро Битрикс
- Запрещено использовать глобальные обработчики в `init.php`
- Запрещено прямое обращение к таблицам БД (только ORM)
- Запрещено использовать старое ядро (`CIBlock*`, `CUser` и т.д.)

## Структура модуля

```
local/modules/vendor.favorites/
├── install/
│   ├── components/
│   │   └── vendor/
│   │       └── favorites.button/
│   │           ├── class.php           # Компонент D7
│   │           ├── templates/
│   │           │   └── .default/
│   │           │       ├── template.php
│   │           │       ├── style.css
│   │           │       └── script.js
│   │           └── .description.php
│   └── index.php
├── lib/
│   ├── Controller/
│   │   └── Favorites.php              # REST Controller
│   ├── Service/
│   │   ├── FavoritesService.php       # Бизнес-логика
│   │   └── CookieService.php          # Работа с cookie
│   ├── Repository/
│   │   └── FavoritesRepository.php    # Работа с БД
│   ├── Model/
│   │   └── FavoritesTable.php         # ORM DataManager
│   └── EventHandler.php               # Обработчики событий
├── lang/
│   └── ru/
├── options.php                        # Страница настроек
└── include.php
```

## Ожидаемые события для обработки

| Событие | Действие |
|---------|----------|
| `OnAfterUserAuthorize` | Миграция избранного из cookie в БД |
| `OnAfterIBlockElementDelete` | Удаление товара из избранного всех пользователей |
| `OnAfterIBlockElementUpdate` | Инвалидация кэша при изменении товара |

## Пример использования компонента

```php
<?php
// На странице товара (detail.php)
$APPLICATION->IncludeComponent(
    'vendor:favorites.button',
    '.default',
    [
        'PRODUCT_ID' => $arResult['ID'],
        'SHOW_COUNTER' => 'N',
        'BUTTON_SIZE' => 'medium',
    ]
);
?>
```

## Дополнительные условия
- Приоритет: enterprise-качество кода
- Код должен быть покрыт PHPDoc-комментариями
- README с инструкцией по установке и использованию
- Компонент должен выглядеть современно и профессионально «из коробки»

