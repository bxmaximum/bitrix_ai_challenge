# Модуль Telegram уведомлений для 1С-Битрикс

Автоматическая отправка критических событий из административного журнала в Telegram.

## Возможности

- ✅ Автоматическое отслеживание критических событий
- ✅ Асинхронная обработка через очереди
- ✅ Защита от дублирования уведомлений
- ✅ Режим тишины для повторяющихся событий
- ✅ Шифрование конфиденциальных данных
- ✅ Настройка через административный интерфейс
- ✅ CLI для обработки очереди
- ✅ Поддержка кластерных окружений
- ✅ Детальное логирование и мониторинг

## Требования

- 1С-Битрикс 20.x+
- PHP 8.1+
- Telegram бот (создать у @BotFather)

## Установка

1. Скопируйте модуль в `/local/modules/barista.telegramnotifier/`
2. Зайдите в административную панель → Настройки → Управление модулями
3. Установите модуль "Telegram уведомления"

## Настройка

### 1. Создание Telegram бота

1. Напишите @BotFather в Telegram
2. Создайте нового бота командой `/newbot`
3. Получите токен бота
4. Добавьте бота в нужные чаты/группы

### 2. Получение Chat ID

Для получения Chat ID отправьте сообщение боту или добавьте его в группу, затем откройте:
```
https://api.telegram.org/bot{TOKEN}/getUpdates
```

### 3. Настройка модуля

Зайдите в административную панель → Сервис → Telegram уведомления:

- **Токен бота**: Полученный от @BotFather
- **Chat ID**: ID чатов для отправки (через запятую)
- **Типы событий**: SECURITY, ERROR, EXCEPTION (по умолчанию)
- **Ключевые слова**: Слова для поиска в описаниях событий

## Обработка очереди

### Автоматическая обработка (cron)

Добавьте в crontab:
```bash
# Каждую минуту
* * * * * cd /path/to/site && php local/modules/barista.telegramnotifier/cli/process_queue.php process

# Очистка старых записей (ежедневно)
0 2 * * * cd /path/to/site && php local/modules/barista.telegramnotifier/cli/process_queue.php cleanup
```

### Ручная обработка

```bash
# Обработать очередь
php cli/process_queue.php process

# Показать статистику
php cli/process_queue.php stats

# Очистить старые записи
php cli/process_queue.php cleanup

# Повторить неудачные отправки
php cli/process_queue.php retry

# Отправить тест
php cli/process_queue.php test
```

## Безопасность

- Токены ботов шифруются AES-256-CBC
- Валидация всех входящих данных
- Защита от CSRF атак
- Маскирование чувствительных данных в логах

## Производительность

- Асинхронная обработка через очереди
- Batch-обработка уведомлений
- Настраиваемые лимиты обработки
- Экспоненциальный backoff для повторов
- Автоочистка старых записей

## Антиспам защита

- Дедупликация идентичных событий
- Автоматический режим тишины
- Настраиваемые интервалы блокировки
- Статистика и рекомендации

## Мониторинг

### Статистика в админке
- Состояние очереди
- Количество отправленных/неудачных уведомлений
- Активные блокировки антиспама

### Логирование
- Файловые логи в `/bitrix/tmp/`
- Записи в журнал событий Битрикс
- Настраиваемые уровни логирования

## API

### Программная отправка

```php
use Barista\TelegramNotifier\Services\QueueService;

$eventData = [
    'AUDIT_TYPE_ID' => 'CUSTOM',
    'ITEM_ID' => 'item_123',
    'DESCRIPTION' => 'Описание события',
    'SEVERITY' => 'ERROR',
    'TIMESTAMP' => time(),
];

QueueService::addNotification($eventData);
```

### Управление настройками

```php
use Barista\TelegramNotifier\Services\ConfigService;

// Включить/выключить модуль
ConfigService::enable();
ConfigService::disable();

// Настроить режим тишины
ConfigService::setSilenceMode(true);
ConfigService::setSilenceDuration(3600);

// Получить все настройки
$settings = ConfigService::getAllSettings();
```

## Структура файлов

```
local/modules/barista.telegramnotifier/
├── include.php                 # Подключение модуля
├── install/
│   ├── index.php              # Установщик
│   ├── version.php            # Версия
│   └── admin/                 # Админ файлы
├── lib/
│   ├── EventHandler.php       # Основной обработчик
│   ├── Models/               # ORM модели
│   └── Services/             # Бизнес-логика
├── cli/
│   └── process_queue.php      # CLI обработчик
├── lang/                      # Языковые файлы
└── README.md                  # Документация
```

## Поддержка кластеров

Модуль корректно работает в кластерных окружениях:
- Использует блокировки для предотвращения дублирования
- Поддерживает распределенную обработку
- Синхронизация через базу данных

## FAQ

**Q: Не приходят уведомления**
A: Проверьте настройки бота, Chat ID и работу cron

**Q: Слишком много уведомлений**
A: Настройте фильтры событий и включите режим тишины

**Q: Ошибки в логах**
A: Проверьте доступность Telegram API и корректность токена

## Поддержка

При возникновении проблем:
1. Проверьте логи модуля
2. Используйте тестовую отправку
3. Убедитесь в правильности настроек

## Лицензия

Проприетарное ПО. Все права защищены. 